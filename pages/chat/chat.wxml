<navigation-bar title="借用聊天" color="black" background="#f8fbff"></navigation-bar>

<view wx:if="{{loading}}" class="missing-page">聊天加载中...</view>

<scroll-view wx:elif="{{session}}" class="scrollarea" scroll-y enhanced enable-flex show-scrollbar="false">
  <view class="page">
    <view class="card">
      <view class="item-title">{{session.itemTitle}}</view>
      <view class="item-meta">借用单号：{{session.orderNo}}</view>
      <view class="item-meta">出借者：{{session.lenderName}}</view>
      <view class="item-meta">借用者：{{session.borrowerName}}</view>
      <view class="item-meta">状态：{{session.status}}</view>
      <view class="item-meta">流程阶段：{{session.orderStageText}}</view>
      <view class="stage-list">
        <view wx:for="{{session.stageSteps}}" wx:key="label" class="stage-chip {{item.done ? 'done' : ''}} {{item.current ? 'current' : ''}}">
          {{item.label}}
        </view>
      </view>
      <view wx:if="{{session.pendingBorrowApproval}}" class="status-tip">当前等待出借者同意后才会进入借用中。</view>
      <view wx:if="{{session.status === '待确认归还'}}" class="status-tip">当前为归还确认阶段，需出借者确认后完成。</view>
      <view wx:if="{{session.canApproveBorrow || session.canRejectBorrow}}" class="action-row">
        <button class="agree-btn" size="mini" bindtap="approveBorrow">同意借用</button>
        <button class="reject-btn" size="mini" bindtap="rejectBorrow">拒绝借用</button>
      </view>
      <view wx:if="{{session.canRequestReturn}}" class="action-row">
        <button class="return-btn" size="mini" bindtap="requestReturn">发起归还确认</button>
      </view>
      <view wx:if="{{session.canCancelBorrow}}" class="action-row">
        <button class="cancel-btn" size="mini" bindtap="cancelBorrow">取消借用</button>
      </view>
      <view wx:if="{{session.canConfirmReturn || session.canRejectReturn}}" class="action-row">
        <button class="agree-btn" size="mini" bindtap="confirmReturn">确认归还</button>
        <button class="reject-btn" size="mini" bindtap="rejectReturn">退回确认</button>
      </view>
    </view>

    <view class="card">
      <view class="section-title">互评</view>
      <view class="rating-meta">对方：{{session.targetName}}</view>
      <view class="rating-meta">对方信用：{{session.targetCreditText}}</view>
      <view class="rating-meta">我的评价：{{session.myRatingText}}</view>
      <view wx:if="{{session.myRating && session.myRating.comment}}" class="rating-comment">“{{session.myRating.comment}}”</view>
      <button wx:if="{{session.canRate}}" class="rate-btn" size="mini" bindtap="submitRating">提交评价</button>
      <view wx:if="{{!session.canRate && session.status !== '已完成'}}" class="rating-tip">借用完成后可评价</view>
    </view>

    <view class="card">
      <view class="section-title">聊天记录</view>
      <scroll-view class="chat-list" scroll-y scroll-with-animation scroll-into-view="{{lastMessageAnchor}}">
        <view class="timeline">
          <view wx:for="{{timelineRecords}}" wx:key="rowKey">
            <view wx:if="{{item.kind === 'marker'}}" class="timeline-marker">{{item.label}}</view>
            <view wx:elif="{{item.kind === 'message'}}" id="msg-{{item.id}}" class="timeline-item">
              <view class="timeline-dot {{item.mine ? 'mine' : ''}} {{item.sender === 'system' ? 'system' : ''}}"></view>
              <view class="timeline-content">
                <view class="timeline-head">
                  <view class="timeline-name">{{item.senderName}}</view>
                  <view class="timeline-time">{{item.timeText}}</view>
                </view>
                <view class="timeline-text {{item.mine ? 'mine' : ''}} {{item.sender === 'system' ? 'system' : ''}}">{{item.text}}</view>
              </view>
            </view>
          </view>
        </view>
        <view wx:if="{{!messageList || messageList.length === 0}}" class="empty">暂无聊天记录，先发一条消息吧。</view>
      </scroll-view>
      <view class="composer">
        <input class="composer-input" placeholder="输入消息..." value="{{messageText}}" bindinput="handleMessageInput" />
        <button class="composer-btn" size="mini" bindtap="sendMessage">发送</button>
      </view>
    </view>

    <view class="card">
      <view class="section-title">借前照片（最多3张）</view>
      <button class="camera-btn" size="mini" bindtap="addBeforePhoto">拍照/上传借前照片</button>
      <view class="photo-grid">
        <image
          wx:for="{{session.beforePhotos}}"
          wx:key="*this"
          class="photo"
          src="{{item}}"
          mode="aspectFill"
          data-url="{{item}}"
          bindtap="previewPhoto"
        ></image>
      </view>
    </view>

    <view class="card">
      <view class="section-title">归还后照片（最多3张）</view>
      <button class="camera-btn" size="mini" bindtap="addAfterPhoto">拍照/上传归还后照片</button>
      <view class="photo-grid">
        <image
          wx:for="{{session.afterPhotos}}"
          wx:key="*this"
          class="photo"
          src="{{item}}"
          mode="aspectFill"
          data-url="{{item}}"
          bindtap="previewPhoto"
        ></image>
      </view>
    </view>

    <view class="card">
      <view class="section-title">前后照片对比</view>
      <view wx:if="{{compareRows.length === 0}}" class="empty">上传借前和归还后照片后可在此对比。</view>
      <view wx:for="{{compareRows}}" wx:key="index" class="compare-row">
        <view class="compare-col">
          <view class="compare-label">借前 {{item.index + 1}}</view>
          <image
            wx:if="{{item.before}}"
            class="compare-photo"
            src="{{item.before}}"
            mode="aspectFill"
            data-url="{{item.before}}"
            bindtap="previewPhoto"
          ></image>
          <view wx:else class="compare-empty">暂无</view>
        </view>
        <view class="compare-col">
          <view class="compare-label">归还后 {{item.index + 1}}</view>
          <image
            wx:if="{{item.after}}"
            class="compare-photo"
            src="{{item.after}}"
            mode="aspectFill"
            data-url="{{item.after}}"
            bindtap="previewPhoto"
          ></image>
          <view wx:else class="compare-empty">暂无</view>
        </view>
      </view>
    </view>
  </view>
</scroll-view>

<view wx:else class="missing-page">未找到借用会话</view>
